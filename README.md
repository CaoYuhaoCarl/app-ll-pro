# AI 对话生成与风格改编系统

这个系统使用两个 Agent 协作生成对话内容：

1. **Agent 1 (初始对话生成)**: 根据指定的背景、目标和轮数生成结构化对话
2. **Agent 2 (对话风格改编)**: 基于 Agent 1 生成的对话和角色特质，生成风格化对话

## 功能特点

### 多 LLM API 支持

系统支持多种 LLM API 提供商：

- **OpenAI API**: 原生支持 OpenAI 的各种模型
- **OpenRouter API**: 支持通过 OpenRouter 访问各大 AI 公司的模型，如 Claude、Llama、Mixtral、Quasar、Deepseek、QWQ等

### 自定义对话内容和角色

#### Agent 1 支持高级自定义功能：

- **自定义词汇**: 可指定希望在对话中出现的特定单词
- **自定义句型**: 可指定希望在对话中使用的特定句型结构
- **结构化输出**: 生成包含原始文本、关键节点、关键词汇、关键句型和对话意图的结构化数据

#### Agent 2 提供丰富的角色定制功能：

- **用户角色设置**:
  - 性格特质: 定义用户的性格特点
  - 称呼方式: 设置他人对用户的称呼
  - 自定义特质: 添加其他特殊的用户特质

- **AI角色设置**:
  - 性格特质: 定义AI的性格特点
  - 口头禅: 设置AI经常使用的口头禅
  - 语气: 调整AI的语气风格
  - 动作/表情描述: 为AI每句话添加动作或表情描述
  - 动作/表情模式: 
    - **自动模式**: 系统根据对话内容和AI性格自动生成合适的动作和表情描述
    - **自定义模式**: 使用用户提供的动作和表情描述库

## 安装指南

1. 克隆仓库到本地

2. 安装依赖包
   ```bash
   pip install -r requirements.txt
   ```

3. 设置环境变量
   - 复制 `.env.example` 到 `.env`
   - 填入你的 API 密钥

   ```
   OPENAI_API_KEY=your_openai_api_key_here
   OPENROUTER_API_KEY=your_openrouter_api_key_here
   ```

## 运行应用

启动 Streamlit 应用：

```bash
streamlit run dialogue_app.py
```

## 使用方法

1. 在侧边栏选择 API 提供商（OpenAI 或 OpenRouter）
2. 输入相应的 API 密钥（如果未在环境变量中设置）
3. 选择 LLM 模型
4. 填写 Agent 1 的基本参数（对话背景、目标、轮数等）
5. 展开"高级选项"可添加自定义单词和句型（可选）
6. 填写 Agent 2 的角色特质参数：
   - 设置用户和AI的详细特质
   - 选择AI动作/表情模式（自动或自定义）
   - 自定义模式下可提供具体的动作和表情描述
7. 点击"生成初始对话"按钮生成对话
8. 点击"生成最终对话"按钮根据角色特质进行风格改编

## OpenRouter 设置

使用 OpenRouter 可以访问多种模型：

1. 注册 [OpenRouter](https://openrouter.ai/) 账户
2. 创建 API 密钥
3. 在应用侧边栏选择 "openrouter" 作为 API 提供商
4. 输入你的 OpenRouter API 密钥
5. 点击"测试API连接并刷新模型列表"按钮获取可用模型
6. 从下拉列表中选择想要使用的模型

## 工作模式

- **人机协作模式**: Agent 1 生成对话后，允许用户编辑，然后传给 Agent 2
- **自动模式**: Agent 1 生成的内容自动传给 Agent 2，无需人工干预

## 更新日志

### 2024-04-05 更新

- **OpenRouter API 速率限制优化**：
  - 添加了重试机制，使用指数退避策略
  - 改进了错误处理和用户反馈
  - 智能解析速率限制响应头获取等待时间
  - 增加了模型缓存以减少请求次数
- **界面增强**：
  - 在侧边栏添加OpenRouter使用提示
  - 更友好的错误信息显示
  - 添加备选模型选项，在API受限时也能使用

## OpenRouter API 使用说明

OpenRouter是一个统一接口，可以访问多种AI模型。使用时需要注意以下几点：

### 账户限制
免费账户有以下限制：
- 每天模型调用次数限制
- 每分钟请求次数限制
- 超出限制会返回429错误

### 处理策略
应用已实现以下策略来应对限制：
- 自动重试机制，最多重试3次
- 智能等待，根据API返回的重置时间计算
- 错误信息明确展示，帮助理解问题

### 最佳实践
为了更顺畅地使用系统：
- 减少不必要的API调用
- 遇到速率限制时等待几分钟再试
- 考虑升级到付费账户获取更高限额
- 如需频繁调用，建议使用OpenAI API 